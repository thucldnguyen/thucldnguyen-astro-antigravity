---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import CallToAction from "../components/CallToAction.astro";
import Lightbox from "../components/Lightbox.astro";
import { getReadingTime } from "../utils/readingTime";
import TagList from "../components/TagList.astro";
import ShareButtons from "../components/ShareButtons.astro";
import RelatedPosts from "../components/RelatedPosts.astro";
import Comments from "../components/Comments.astro";
import AnimateOnScroll from "../components/AnimateOnScroll.astro";
import JsonLd from "../components/JsonLd.astro";
import bannerImage from "../assets/banner.jpg";

type Props = CollectionEntry<"blog">["data"] & { body?: string };

const {
	title,
	description,
	date,
	updatedDate,
	heroImage,
	featuredImage,
	image,
} = Astro.props;

// Logic to determine which image to use (support various frontmatter fields)
const resolvedImage = heroImage || featuredImage || image || bannerImage;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={title}
			description={description}
			image={resolvedImage}
			ogType="article"
		/>
		{/* Preload LCP image for blog post */}
		{
			resolvedImage && (
				<link
					rel="preload"
					as="image"
					href={
						typeof resolvedImage === "string"
							? resolvedImage
							: resolvedImage.src
					}
				/>
			)
		}
		<meta property="article:published_time" content={date.toISOString()} />
		{updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
		<meta property="article:author" content="https://thucldnguyen.com/about" />
		<JsonLd data={{
			"@context": "https://schema.org",
			"@type": "BlogPosting",
			"headline": title,
			"description": description,
			"image": resolvedImage ? new URL(typeof resolvedImage === "string" ? resolvedImage : resolvedImage.src, "https://thucldnguyen.com").href : undefined,
			"datePublished": date.toISOString(),
			"dateModified": updatedDate ? updatedDate.toISOString() : date.toISOString(),
			"author": {
				"@type": "Person",
				"name": "Thuc Nguyen",
				"url": "https://thucldnguyen.com",
				"jobTitle": "Senior Product Manager",
				"worksFor": {
					"@type": "Organization",
					"name": "Axon"
				}
			},
			"publisher": {
				"@type": "Person",
				"name": "Thuc Nguyen",
				"url": "https://thucldnguyen.com"
			},
			"mainEntityOfPage": {
				"@type": "WebPage",
				"@id": new URL(Astro.url.pathname, "https://thucldnguyen.com").href
			}
		}} />
	</head>

	<body
		class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300"
	>
		<Header />
		<main class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
			<article
				class="max-w-4xl mx-auto bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors duration-300"
			>
				<div class="w-full relative bg-slate-100 dark:bg-slate-800">
					{
						typeof resolvedImage === "string" ? (
							<img
								width={1020}
								height={574}
								src={resolvedImage}
								alt=""
								loading="eager"
								fetchpriority="high"
								class="w-full h-auto object-cover"
							/>
						) : (
							<Image
								width={1020}
								src={resolvedImage}
								alt=""
								loading="eager"
								fetchpriority="high"
								class="w-full h-auto object-cover"
							/>
						)
					}
				</div>
				<div class="p-8 md:p-12 lg:p-16">
					<div class="text-center mb-12">
						<div
							class="text-slate-500 dark:text-slate-400 mb-4 flex items-center justify-center gap-2"
						>
							<FormattedDate date={date} />
							<span>â€¢</span>
							<span>{getReadingTime(Astro.props.body)}</span>
						</div>
						{
							updatedDate && (
								<div class="italic text-sm text-slate-500 dark:text-slate-400 mb-4">
									Last updated on{" "}
									<FormattedDate date={updatedDate} />
								</div>
							)
						}
						<h1
							class="text-4xl md:text-5xl font-bold tracking-tight text-slate-900 dark:text-white mb-4"
						>
							{title}
						</h1>
						<hr class="w-24 h-1 bg-accent mx-auto mb-6" />

						<div class="flex justify-center mb-6">
							<TagList tags={Astro.props.tags || []} />
						</div>
					</div>
					<div
						class="prose prose-lg prose-slate dark:prose-invert mx-auto max-w-none"
					>
						<slot />

						<hr
							class="my-8 h-px border-0 bg-slate-200 dark:bg-slate-800"
						/>

						<ShareButtons
							title={title}
							description={description}
							url={Astro.url.href}
						/>

						<Comments />

						<div class="mt-12">
							<CallToAction />
						</div>
					</div>
				</div>
			</article>

			<hr class="my-12 border-transparent" />

			<div class="animate-on-scroll">
				<RelatedPosts
					currentSlug={Astro.params.slug || ""}
					tags={Astro.props.tags || []}
				/>
			</div>
		</main>
		<Footer />
		<Lightbox />
		<AnimateOnScroll />
	</body>
</html>
