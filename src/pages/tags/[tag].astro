---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PostCard from "../../components/PostCard.astro";
import { getCollection } from "astro:content";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");

    // Extract all unique tags
    const uniqueTags = [
        ...new Set(
            allPosts
                .map((post) => post.data.tags)
                .flat()
                .filter(Boolean),
        ),
    ];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter(
            (post) => tag && post.data.tags?.includes(tag),
        );
        // Sort logic similar to index (newest first)
        filteredPosts.sort(
            (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
        );

        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead
            title={`${tag} - ${SITE_TITLE}`}
            description={SITE_DESCRIPTION}
        />
    </head>
    <body
        class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300"
    >
        <Header />
        <main class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-12">
                <a
                    href="/blog"
                    class="inline-flex items-center gap-2 text-slate-500 hover:text-violet-600 mb-6 transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="lucide lucide-arrow-left"
                        ><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"
                        ></path></svg
                    >
                    Back to Blog
                </a>
                <h1
                    class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl capitalize"
                >
                    Tagged: <span class="text-violet-600 dark:text-violet-400"
                        >{tag}</span
                    >
                </h1>
                <p class="text-slate-600 dark:text-slate-400 mt-2">
                    Found {posts.length}
                    {posts.length === 1 ? "post" : "posts"}
                </p>
            </div>

            <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {
                    posts.map((post) => (
                        <li>
                            <PostCard post={post} />
                        </li>
                    ))
                }
            </ul>
        </main>
        <Footer />
    </body>
</html>
